# pengfeng rest api
## 部署方法
当前目录为代码的根目录，一切指令均要在此目录输入。此外，权限不够可能需要使用`sudo`临时提升权限。
### 拉取最新代码
``
git pull
``

### 修改Docker相关文件
主要是需要修改`Dockerfile`和`docker-compose.yml`文件，使其符合要求并不会和本机其他程序冲突。

### 关闭正在运行的镜像
``
docker-compose down
``

### 运行部署脚本
``
bash deploy.sh
``

注意，此脚本内容可能需要根据Docker文件进行修改。

### 后台进程运行
在执行deploy.sh成功的情况下，可以考虑使用后台进程进行部署。

``
docker-compose up -d
``

## 手动运行方法

以127.0.0.1:8000为例，按照下面的步骤操作。

### 运行单元测试

``
python manage.py test
``

### 数据库同步

``
python manage.py migrate
``

### 创建管理员账户

``
python manage.py createsuperuser
``

### 启动主程序

``
python manage.py runserver 127.0.0.1:8000
``

### 获取API的Token值

发动POST请求至`127.0.0.1:8000/api/v1/api-token-auth/`，发送的数据字段为`username`和`password`。若验证成功，则会返回下面形式的`token`：

``
{ 'token' : '9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b' }
``

这个`token`值在调用API时会用到。

### 调用API

调用API时，需要在请求头中包含`token`的值。以`127.0.0.1:8000/api/v1/people`为例：

``
curl -X GET http://127.0.0.1:8000/api/v1/people/?format=json -H 'Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b'
``

调用成功后，返回数据为：

``
[{"pk":11,"uuid":"8fbe770c-73bc-11e8-8a80-e82aeabca066","name":"BEJ0","position":"employee","image":"****"},....]
``
### 构建Docker镜像

``
sudo docker build -t shengwubin/face:v0.0.4 .
``

### 执行Docker-Compose命令

``
sudo docker-compose up
``

## 模型设计

### Person
1. uuid - 自动生成的uuid，全局唯一
2. name - 姓名
3. position - 职位
4. image - Base64编码图片

### Record
1. uuid - 自动生成的uuid，全局唯一
2. created - 记录创建时间
3. target - 匹配到的员工（可为None，表示匹配不成功）
4. image - 匹配用到的Base64编码图片

## 已确认事项
1. 需要额外设计美观的数据录入UI。
2. 一切请求均由Android端主动发起，并设计REST和普通的HTTP接口完成功能。
3. 增加批量导入功能
4. 数据录入UI增加分页和筛选功能
5. 增加Android终端监控功能
6. 讨论页面布局，增加copyright等信息

## 待确认事项
1. 外键关系采用哪一种方式进行设计？基于主键的关系、基于超链接的关系、基于嵌套的关系均可以满足需求，需要双方商议后选一个最方便的。
2. 获取Token时采用什么加密方式保护用户名和密码？可以选择一种常见的加密手段进行加密保护。
3. 传送图片时，传送原始文件还是直接编码成base64字符串进行传送？原始文件可能会小一些，但是不利于管理；base64字符串比较简单，但是体积会稍微增大，且使用的时候编码解码会消耗一定的时间。
4. 数据同步时使用什么方式进行压缩和加密？传送字符串还是直接传送文件？
5. 人脸特征保存在什么地方？服务器用不用提特征？

## 已完成的功能测试
1. 查看人员：登陆网站->进入后台->点击人员列表->查看人员信息->操作完毕
2. 新增人员（单个）：登陆网站->进入后台->点击增加按钮->录入信息->点击保存按钮->操作完毕
3. 修改人员：登陆网站->进入后台->点击人员列表->点击已有人员->编辑信息->点击保存按钮->操作完毕
4. 删除人员：登陆网站->进入后台->点击人员列表->选择已有人员->选择删除动作->点击执行按钮->操作完毕
5. 增量更新：Android端获取自身版本号->发送GET请求获取版本差异->Android端更新自身数据->操作完毕
6. 匹配记录的上传：Android端产生匹配记录->发送POST请求上传记录->服务器保存匹配记录->操作完毕

## 尚未完成的功能测试

## 已知问题



## 已修复的问题
1. 匹配记录过多时，匹配记录页面打开会有速度问题
2. 人员过多时，编辑终端页面打开会有速度问题
3. 设备编辑页面多选框加载速度慢问题

## 版本更新

### v0.0.1
1. 增加了模型定义和REST接口。
2. 实现了基于Token的权限验证。

### v0.0.2
1. 使用基于主键的外键关系表达
2. 增加REST批量操作接口

### v0.0.3
1. 自动生成REST API文档
2. 添加单元测试

### v0.0.4
1. 根据实际需求修改了模型的一些字段
2. 增加了数据增删改查的admin站点
3. REST API返回值进行了一些修改

### v0.0.5
1. 完善数据录入功能

### v0.0.6
1. 增加人脸数据增量同步功能
2. 增加匹配记录上传功能
3. 添加相应的单元测试
4. 设计了数据同步接口

### v0.0.7
1. 修改了部分同步接口
2. 增加了bootstrap主题的人脸数据录入UI

### v0.0.8
1. 增加了批量导入功能
2. 修复了已知的问题

### v0.0.9
1. 增加了终端监测功能
2. 增强型UI基本完成
3. 修复了已知的问题
4. 设计了心跳保持的接口

### v0.0.10
1. 优化了增量更新方法
2. 增加了增量更新的缓存功能

### v0.0.11
1. 增加了匹配记录的展示功能
2. 提供匹配记录的查询功能
3. 使用postgresql数据库进行数据存储
4. 匹配记录按创建时间进行逆序排序

### v0.1.0
1. 实现了人员的软删除
2. REST API实现筛选功能
3. REST API拓展以uuid为核心的接口
4. 增加了一些单元测试

### v0.1.1
1. 优化了人脸数据管理界面
2. 增加单元测试
3. 修复已知问题
4. 根据需求修改部分接口

### v0.2.0
1. 人脸数据管理增加了设备推送选项
2. 优化了匹配记录查询页面的性能
3. 增加考勤报表功能
4. 增加设备管理功能
5. 优化了设备监控功能

### v0.2.1
1. 修复了已知的问题
2. 增加了个人考勤报表
3. 优化了设备监控功能
4. 增加了接口说明
5. 增加了单元测试
